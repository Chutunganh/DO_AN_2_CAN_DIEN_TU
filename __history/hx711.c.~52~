#include <16F877A.h>
#fuses XT, NOWDT, NOPROTECT, NOBROWNOUT, NOLVP, NOPUT, NOWRT, NODEBUG, NOCPD
#use delay(clock = 2 MHz)
#define DT1 pin_c0
#define SCK pin_c1
#define RESET_BTN PIN_A0
#define use_portb_lcd TRUE
#include <lcd.c>

float SCALE = 36;

unsigned int32 readCount(void) {
   unsigned int32 data;
   unsigned int8 j;
   output_bit(DT1, 1);
   output_bit(SCK, 0);
   data = 0;
   while (input(DT1));
   for (j = 0; j < 24; j++) {
      output_bit(SCK, 1);
      data = data << 1;
      output_bit(SCK, 0);
      if (input(DT1)) {
         data++;
      }
   }
   output_bit(SCK, 1);
   data = data ^ 0x800000;
   output_bit(SCK, 0);
   return data;
}

int32 readAverage(void) {
   unsigned int32 sum = 0;
   for (int k = 0; k < 10; k++) {
      sum = sum + readCount();
   }
   return sum / 10;
}

// Hàm hi?n th? ch? t? t? (b? hàm này vì dã vi?t tr?c ti?p)
/*
void displayTextSlowly(char* text, int8 col, int8 row) {
   int8 i = 0;
   while(text[i] != '\0') {
      lcd_gotoxy(col + i, row);
      lcd_putc(text[i]);
      delay_ms(150);  // Delay gi?a m?i ký t?
      i++;
   }
}
*/

void main() {
   setup_adc_ports(NO_ANALOGS);
   setup_adc(ADC_OFF);
   set_tris_a(0x01);   // RA0 la input
   lcd_init();
   
   // Hi?n th? Loading
   printf(lcd_putc, "\f  Loading");
   delay_ms(500);
   printf(lcd_putc, "\f  Loading.");
   delay_ms(500);
   printf(lcd_putc, "\f  Loading..");
   delay_ms(500);
   printf(lcd_putc, "\f  Loading...");
   delay_ms(500);
   
   // Xóa màn hình và hi?n th? tên t? t?
   printf(lcd_putc, "\f");
   delay_ms(300);
   
   // Hi?n th? "Chu Tung Anh" t?ng ký t?
   lcd_gotoxy(2, 1);
   lcd_putc('C'); delay_ms(150);
   lcd_putc('h'); delay_ms(150);
   lcd_putc('u'); delay_ms(150);
   lcd_putc(' '); delay_ms(150);
   lcd_putc('T'); delay_ms(150);
   lcd_putc('u'); delay_ms(150);
   lcd_putc('n'); delay_ms(150);
   lcd_putc('g'); delay_ms(150);
   lcd_putc(' '); delay_ms(150);
   lcd_putc('A'); delay_ms(150);
   lcd_putc('n'); delay_ms(150);
   lcd_putc('h'); delay_ms(150);
   delay_ms(800);
   
   // Hi?n th? "Can dien tu" t?ng ký t?
   lcd_gotoxy(3, 2);
   lcd_putc('C'); delay_ms(150);
   lcd_putc('a'); delay_ms(150);
   lcd_putc('n'); delay_ms(150);
   lcd_putc(' '); delay_ms(150);
   lcd_putc('d'); delay_ms(150);
   lcd_putc('i'); delay_ms(150);
   lcd_putc('e'); delay_ms(150);
   lcd_putc('n'); delay_ms(150);
   lcd_putc(' '); delay_ms(150);
   lcd_putc('t'); delay_ms(150);
   lcd_putc('u'); delay_ms(150);
   delay_ms(1500);
   
   // Ð?c giá tr? offset
   printf(lcd_putc, "\f Khoi tao...");
   delay_ms(500);
   unsigned int32 offset = readAverage();
   
   printf(lcd_putc, "\f   San sang!");
   delay_ms(1000);
   
   float gram;
   while (TRUE) {
      // N?u nh?n nút thì c?p nh?t offset
      if (input(RESET_BTN) == 0) {
         delay_ms(5);
         if (input(RESET_BTN) == 0) {
            printf(lcd_putc, "\f  Dang tara...");
            offset = readAverage();
            printf(lcd_putc, "\f   Hoan tat!");
            delay_ms(800);
         }
      }
   
      unsigned int32 read1 = readAverage();
      signed int32 delta = (signed int32)read1 - (signed int32)offset;
      
      if (delta < 0) delta = 0;
      
      float value = (float)delta / SCALE;   // value là gram
      printf(lcd_putc, "\f%.0f g", value);
      delay_ms(300);
   }
}
