#include <16f877a.h>
#include <def_877a.h>
#device *=16 ADC=8
#FUSES NOWDT, HS, NOPUT, NODEBUG, NOBROWNOUT, NOLVP, NOCPD, NOWRT
#use delay(clock = 20000000)

// ===== HX711 =====
#define DT1        PIN_C0
#define SCK        PIN_C1

// ===== NÚT / POWER (b?n có th? b? n?u không dùng) =====
#define RESET_BTN  PIN_A0       // dùng d? TARE và CALIB
#define ONOFF_BTN  PIN_A1
#define LCD_POWER  PIN_A2

// ===== LCD I2C =====
#use i2c(MASTER, SDA=PIN_C4, SCL=PIN_C3, stream=I2C_LCD, FAST=100000)
#include <I2C_LCD.c>   // thu vi?n b?n dua (LCD_Begin, LCD_Goto, LCD_Out, LCD_Cmd,...)

// ===== CÂN CH?NH =====
#define CAL_WEIGHT_GRAMS 100.0  // <<< Ð?I THÀNH QU? CÂN CHU?N B?N CÓ (vd: 100.0, 200.0, 500.0)
float SCALE = 880.0;            // s? du?c tính l?i sau khi calib
int1 system_on = TRUE;

// -------- HX711 d?c 24-bit (dã s?a dúng) ----------
signed int32 readCount(void) {
   unsigned int32 data = 0;
   int8 j;

   output_low(SCK);

   // Ch? HX711 s?n sàng (DT xu?ng 0)
   while (input(DT1));

   for (j = 0; j < 24; j++) {
      output_high(SCK);
      delay_us(1);
      data = (data << 1) | (input(DT1) ? 1 : 0);
      output_low(SCK);
      delay_us(1);
   }

   // Xung th? 25: Gain 128 (Channel A)
   output_high(SCK); delay_us(1);
   output_low(SCK);  delay_us(1);

   // sign extend 24-bit -> 32-bit signed
   if (data & 0x800000) data |= 0xFF000000;

   return (signed int32)data;
}

signed int32 readAverage(void) {
   signed int32 sum = 0;
   int k;
   for (k = 0; k < 10; k++) {
      sum += readCount();
      delay_ms(10);
   }
   return sum / 10;
}
// -------------------------------------

// ==== ti?n ích ch? nh? nút (ch?ng d?i don gi?n) ====
void wait_release(pin_t p) {
   while(!input(p)) { delay_ms(10); }
   delay_ms(50);
}

void main() {
   setup_adc_ports(NO_ANALOGS);
   setup_adc(ADC_OFF);

   // RA0,RA1 input; RA2 output
   set_tris_a(0x03);

   // C0 input (DT), C1 output (SCK). C3/C4 I2C do CCS di?u khi?n.
   set_tris_c(0b00011001); // RC0=1 input, RC1=0 output, RC3/RC4=1 (I2C), còn l?i tu? b?n

   // B?t ngu?n LCD
   output_high(LCD_POWER);
   delay_ms(200);

   // Init LCD (0x4E ~ addr 0x27; n?u LCD b?n 0x3F thì d?i 0x7E)
   LCD_Begin(0x4E);
   delay_ms(100);

   LCD_Goto(3,1); printf(LCD_Out, "Loading...");
   delay_ms(800);

   // ======================
   // 1) TARE (l?y offset 0)
   // ======================
   LCD_Goto(1,1); printf(LCD_Out, "De can = 0");
   LCD_Goto(1,2); printf(LCD_Out, "Dang tare...");
   delay_ms(500);

   signed int32 offset = readAverage();

   // ==========================================
   // 2) CALIB SCALE: d?t qu? cân chu?n r?i b?m RESET
   // ==========================================
   LCD_Cmd(LCD_CLEAR);
   LCD_Goto(1,1); printf(LCD_Out, "Dat %4.0f g", CAL_WEIGHT_GRAMS);
   LCD_Goto(1,2); printf(LCD_Out, "Nhan RESET...");

   // ch? nh?n RESET d? ch?p giá tr? calib
   while(input(RESET_BTN)) { delay_ms(20); }
   delay_ms(30);
   if(!input(RESET_BTN)) {
      signed int32 rawCal = readAverage();
      signed int32 deltaCal = rawCal - offset;
      if(deltaCal < 1) deltaCal = 1; // tránh chia 0

      SCALE = (float)deltaCal / CAL_WEIGHT_GRAMS;

      wait_release(RESET_BTN);
   }

   // báo SCALE
   LCD_Cmd(LCD_CLEAR);
   LCD_Goto(1,1); printf(LCD_Out, "SCALE ok");
   LCD_Goto(1,2); printf(LCD_Out, "%7.2f ct/g", SCALE);
   delay_ms(1200);

   // màn hình s?n sàng
   LCD_Cmd(LCD_CLEAR);
   LCD_Goto(1,1); printf(LCD_Out,"CAN NANG:");
   float last_grams = -9999.0;

   while(TRUE) {

       /* ===== NÚT ON/OFF ===== */
       if (!input(ONOFF_BTN)) {
           delay_ms(30);
           if (!input(ONOFF_BTN)) {
               system_on = !system_on;

               if (system_on) {
                   output_high(LCD_POWER);
                   delay_ms(150);
                   LCD_Begin(0x4E);

                   // Tare l?i khi b?t
                   offset = readAverage();

                   LCD_Cmd(LCD_CLEAR);
                   LCD_Goto(1,1);
                   printf(LCD_Out,"CAN NANG:");
               } else {
                   output_low(LCD_POWER);
               }

               wait_release(ONOFF_BTN);
           }
       }

       if (!system_on) {
           delay_ms(100);
           continue;
       }

       /* ===== RESET = TARE nhanh (v? 0) ===== */
       if (!input(RESET_BTN)) {
           delay_ms(30);
           if (!input(RESET_BTN)) {
               offset = readAverage();   // tare
               last_grams = -9999.0;
               wait_release(RESET_BTN);
           }
       }

       /* ===== 3) Ð?C CÂN: weight = (raw - offset)/SCALE ===== */
       signed int32 raw = readAverage();
       signed int32 delta = raw - offset;

       // n?u b?n mu?n cho phép âm thì b? do?n này
       if (delta < 0) delta = 0;

       float grams = (float)delta / SCALE;

       /* ===== CH?NG RUNG + NGU?NG ===== */
       if (grams < 0.2) grams = 0.0;                 // dead zone
       grams = ((int)(grams * 10 + 0.5)) / 10.0;     // làm tròn 0.1g

       float diff = grams - last_grams;
       if (diff < 0) diff = -diff;

       /* ===== HI?N TH? ===== */
       if (diff >= 0.1) {
           LCD_Goto(1,2);
           printf(LCD_Out,"                ");
           LCD_Goto(1,2);
           printf(LCD_Out,"%5.1f g", grams);
           last_grams = grams;
       }

       delay_ms(300);
   }
}

